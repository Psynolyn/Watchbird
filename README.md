# ğŸ¦ Watchbird: Bird Movement Anomaly Detection

<div align="center">

**Real-time anomaly detection system for monitoring bird movement patterns**

[![Python](https://img.shields.io/badge/python-3.8+-blue.svg)](https://www.python.org/downloads/)
[![Streamlit](https://img.shields.io/badge/streamlit-1.0+-red.svg)](https://streamlit.io/)
[![License](https://img.shields.io/badge/license-MIT-green.svg)](LICENSE)
[![Supabase](https://img.shields.io/badge/database-Supabase-green.svg)](https://supabase.com/)

[Features](#-core-features) â€¢ [Quick Start](#-quick-start) â€¢ [Usage Guide](#-usage-guide) â€¢ [Architecture](#%EF%B8%8F-system-architecture) â€¢ [Model Details](#-the-anomaly-detection-model)

</div>

---

## ğŸ“‹ Overview

Watchbird is a full-stack, real-time anomaly detection system designed to monitor bird movement data using GPS tracking. It leverages machine learning to automatically identify unusual behaviors such as sudden altitude drops, hovering patterns, or erratic speed changes.

The application answers a critical question: **"Is this bird behaving normally?"**

Built with a **Streamlit frontend** for interactive visualization, a **Python backend** for model training and inference, and a **Supabase (PostgreSQL) database** for data persistence, Watchbird moves beyond simple data visualization to provide an intelligent, automated monitoring tool.

## ğŸ¯ Core Features

### ğŸ—ºï¸ Interactive Map Dashboard
- Real-time visualization of device locations using Streamlit and Folium
- Anomalies highlighted in red, normal behavior in blue
- Live tracking with automatic map updates

### ğŸ§  Unsupervised Anomaly Detection
- **Isolation Forest algorithm** for detecting "few and different" outliers
- No pre-labeled data required
- Highly effective at identifying complex behavioral anomalies

### ğŸ”¬ Intelligent Feature Engineering
The model processes **40+ engineered features** to capture complex behaviors:
- **Movement Metrics**: Speed, acceleration, vertical speed
- **Statistical Analysis**: Rolling mean/std over multiple time windows
- **Behavioral Flags**: Hovering detection, burst movement identification
- **Normalization**: Z-scores to detect deviation from recent patterns

### ğŸ¯ Robust Post-Processing
- Filters isolated single-point anomalies
- Focuses on **anomalous events** (clusters of anomalous points)
- Dramatically reduces false positives

### ğŸ“¡ Online Monitoring
- Active data fetching and real-time inference
- Device-specific model application
- Automatic database updates with detected anomalies

### âš™ï¸ Model Management
- Train multiple models from the web UI
- Save and version control models
- Assign different models to different devices (e.g., one for eagles, another for vultures)

## ğŸš€ Quick Start

### Prerequisites

- Python 3.8 or higher
- Supabase account
- Git

### Installation

**1. Clone the repository**

```bash
git clone https://github.com/Psynolyn/Watchbird.git
cd Watchbird
```

**2. Set up Python environment**

```bash
# Create virtual environment
python -m venv venv

# Activate virtual environment
# On macOS/Linux:
source venv/bin/activate
# On Windows:
venv\Scripts\activate

# Install dependencies
pip install -r requirements.txt
```

**3. Create required directories**

```bash
mkdir models results dataset
```

**4. Configure Supabase**

Create a new project on [Supabase](https://supabase.com/) and set up your database tables:

**Devices Table:**
```sql
CREATE TABLE public.Devices (
  Device_id INT PRIMARY KEY,
  Device_name TEXT NOT NULL UNIQUE,
  Status TEXT,
  Color_1 TEXT,        -- Map path color (e.g., '#FF0000')
  Color_2 TEXT,        -- Map fill color (e.g., '#FF0000')
  IF_model TEXT        -- Assigned model name (e.g., 'model_v1')
);
```

**Data Table:**
```sql
CREATE TABLE public.Data (
  Id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  Device_id INT REFERENCES public.Devices(Device_id),
  Timestamp TIMESTAMPTZ NOT NULL,
  Latitude FLOAT NOT NULL,
  Longitude FLOAT NOT NULL,
  Altitude FLOAT,
  speed_m_s FLOAT,
  delta_alt FLOAT,
  dt FLOAT,
  distance_m FLOAT,
  bearing FLOAT,
  acceleration FLOAT,
  Anomaly INT DEFAULT 1    -- 1 = Normal, -1 = Anomaly
);

-- Create indexes for performance
CREATE INDEX ON public.Data (Device_id, "Timestamp" DESC);
ALTER TABLE public.Data ENABLE ROW LEVEL SECURITY;
```

> **Note:** Feature columns (`speed_m_s`, `dt`, etc.) are optional. The system will compute them automatically if missing.

**5. Configure Streamlit secrets**

Create `.streamlit/secrets.toml`:

```toml
SUPABASE_URL = "YOUR_PROJECT_URL"
SUPABASE_KEY = "YOUR_PROJECT_ANON_KEY"
```

**6. Launch the application**

```bash
streamlit run app.py
```

The application will open in your default browser at `http://localhost:8501`

## ğŸ“– Usage Guide

Watchbird operates in three distinct modes, accessible from the sidebar:

### ğŸ“ Mode 1: Train (First Step)

Train a model before you can monitor:

1. Select **"Train"** from the Mode dropdown
2. Choose one or more devices for training data
3. Enter a unique model name (e.g., `eagle_model_v1`)
4. Click **"Train"**

The system will:
- Fetch all historical data
- Engineer features
- Train an Isolation Forest model
- Save model files (`.pkl`) to `/models` directory

### ğŸ”— Mode 2: Device Model Assignment (Second Step)

Assign trained models to specific devices:

1. Select **"Device Model Assignment"** from the Mode dropdown
2. Choose device(s) to configure
3. Select the appropriate model from the dropdown for each device
4. The assignment is saved to the Supabase database

This allows device-specific detection (e.g., different models for different bird species).

### ğŸ“Š Mode 3: Monitor (Ongoing Use)

The main dashboard for live monitoring:

1. Select **"Monitor"** from the Mode dropdown
2. Choose devices to display on the map
3. Click **"Reload & Monitor"**

The system will:
- Fetch new GPS data points
- Load device-specific models
- Run inference on new data
- Save detected anomalies to database
- Update the map visualization

**Visual Indicators:**
- ğŸ”µ **Small blue circles** = Normal behavior
- ğŸ”´ **Large red circles** = Detected anomalies

Check the **"Monitoring Stats"** sidebar for processing metrics.

## ğŸ—ï¸ System Architecture

The application follows a continuous loop of training, assignment, and monitoring:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Data Ingestion â”‚ â† GPS data streams into Supabase
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    â”‚   Training   â”‚ â†’ Engineers features, trains model, saves .pkl files
         â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”œâ”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    â”‚  Assignment  â”‚ â†’ Links devices to specific models in database
         â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â””â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  Monitoring  â”‚ â†’ Loads models, runs inference, detects anomalies
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â””â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚ Visualization  â”‚ â†’ Updates map with anomaly markers
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Detailed Workflow

**Training Phase:**
1. User selects devices and model name via UI
2. `app.py` triggers `train.run_pipeline`
3. System loads historical data, engineers features, scales data
4. Trains Isolation Forest model
5. Saves model and scaler as `.pkl` files to `/models`

**Assignment Phase:**
1. User selects device and available model
2. `app.py` calls `db_operations.save_device_if_model`
3. Updates `IF_model` column in Supabase `Devices` table

**Monitoring Phase:**
1. User clicks "Reload & Monitor"
2. For each selected device:
   - Looks up assigned model name
   - Loads corresponding `.pkl` files
   - Fetches new data points
   - Runs inference pipeline
   - Saves anomalies back to database
3. Map visualization updates automatically

## ğŸ§  The Anomaly Detection Model

### Why Isolation Forest?

The Isolation Forest algorithm was chosen for its unique strengths:

- **Unsupervised Learning**: No pre-labeled data required
- **Efficiency**: Scales well with large datasets (O(n log n))
- **Robustness**: Handles complex, multi-modal "normal" behaviors effectively
- **Outlier Detection**: Excels at identifying "few and different" patterns

### Feature Engineering (40+ Features)

The model's intelligence comes from comprehensive feature extraction:

#### Base Metrics
- `dt`: Time delta between consecutive points
- `distance_m`: Distance traveled
- `speed_m_s`: Speed in meters per second
- `vertical_speed`: Rate of altitude change
- `acceleration`: Rate of speed change

#### Statistical Features
Rolling statistics over multiple windows (3, 5, and 9 points):
- `speed_mean_3/5/9`: Short to medium-term speed trends
- `speed_std_3/5/9`: Speed variability
- `acceleration_mean_3/5/9`: Acceleration patterns
- `vertical_speed_mean_3/5/9`: Altitude change trends

#### Behavioral Flags
- **`hover_flag`**: Triggered when speed < 0.5 m/s for > 600 seconds
- **`burst_flag`**: Triggered by high acceleration (> 2.0 m/sÂ²) or rapid speed changes

#### Normalization Features
- **`speed_zscore`**: Standard deviations from recent (10-point) average
- **`log_speed`** / **`log_distance`**: Log transforms for skewed distributions

#### Temporal Features
- `hour_norm`: Time of day patterns
- `day_of_week_norm`: Weekly behavioral patterns

### Data Scaling

Features are scaled using **RobustScaler**, which is less sensitive to outliersâ€”critical since we're trying to detect them.

### Anomaly Event Filtering

The system implements intelligent post-processing to reduce false positives:

1. **Event Grouping**: Consecutive anomaly points are grouped into "events"
2. **Gap Threshold**: Uses 900-second `EVENT_GAP_THRESHOLD` to define event boundaries
3. **Minimum Event Size**: Discards events with fewer than 2 points (`MIN_EVENT_SIZE`)

**Result**: The system ignores isolated, single-point anomalies and focuses only on **sustained anomalous behavior**, dramatically improving alert quality.

## ğŸ› ï¸ Technology Stack

| Component | Technology |
|-----------|------------|
| **Frontend** | Streamlit, Streamlit-Folium |
| **Backend & ML** | Python |
| **Machine Learning** | Scikit-learn (IsolationForest, RobustScaler) |
| **Data Processing** | Pandas, NumPy |
| **Database** | Supabase (PostgreSQL) |
| **Geospatial** | Folium, Geopy |
| **Model Persistence** | Joblib |

## ğŸ“ Project Structure

```
Watchbird/
â”œâ”€â”€ app.py                  # Main Streamlit application
â”œâ”€â”€ train.py                # ML pipeline and feature engineering
â”œâ”€â”€ db_operations.py        # Database interactions
â”œâ”€â”€ reload_and_monitor.py   # Real-time monitoring logic
â”œâ”€â”€ requirements.txt        # Python dependencies
â”œâ”€â”€ .streamlit/
â”‚   â””â”€â”€ secrets.toml        # Supabase credentials (not in repo)
â”œâ”€â”€ models/                 # Trained model .pkl files
â”œâ”€â”€ results/                # Anomaly CSVs and plots
â””â”€â”€ dataset/                # Training data cache
```

## ğŸ“Š Requirements

Create a `requirements.txt` file with:

```txt
streamlit
streamlit-folium
supabase
pandas
numpy
scikit-learn
geopy
folium
joblib
matplotlib
seaborn
```

## ğŸ”’ Security Notes

- Never commit your `.streamlit/secrets.toml` file
- Add it to `.gitignore`
- Use environment variables for production deployments
- Enable Row Level Security on Supabase tables

## ğŸ¤ Contributing

Contributions are welcome! Please feel free to submit a Pull Request.

## ğŸ“ License

This project is licensed under the MIT License - see the LICENSE file for details.

## ğŸ™ Acknowledgments

- Built with â¤ï¸ for wildlife conservation and monitoring
- Powered by the Isolation Forest algorithm
- Inspired by the need for automated wildlife behavioral analysis

## ğŸ“ Support

For questions, issues, or suggestions:
- Open an [issue](https://github.com/Psynolyn/Watchbird/issues)
- Check the [documentation](https://github.com/Psynolyn/Watchbird/wiki)

---

<div align="center">

**[â¬† Back to top](#-watchbird-bird-movement-anomaly-detection)**

Made by [Psynolyn](https://github.com/Psynolyn)

</div>